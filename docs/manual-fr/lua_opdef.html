<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>lua_opdef</title>
    <link rel="stylesheet" type="text/css" href="csound.css" />
    <link rel="stylesheet" type="text/css" href="syntax-highlighting.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.78.1" />
    <link rel="home" href="index.html" title="Manuel de référence canonique de Csound" />
    <link rel="up" href="OpcodesTop.html" title="Opcodes et opérateurs de l'orchestre" />
    <link rel="prev" href="lua_exec.html" title="lua_exec" />
    <link rel="next" href="lua_opcall.html" title="lua_opcall" />
  </head>
  <body>
    <div class="navheader">
      <table width="100%" summary="Navigation header">
        <tr>
          <th colspan="3" align="center">lua_opdef</th>
        </tr>
        <tr>
          <td width="20%" align="left"><a accesskey="p" href="lua_exec.html">Précédent</a> </td>
          <th width="60%" align="center">Opcodes et opérateurs de l'orchestre</th>
          <td width="20%" align="right"> <a accesskey="n" href="lua_opcall.html">Suivant</a></td>
        </tr>
      </table>
      <hr />
    </div>
    <div class="refentry">
      <a id="lua_opdef"></a>
      <div class="titlepage"></div>
      <a id="Indexlua_opdef" class="indexterm"></a>
      <div class="refnamediv">
        <h2>
          <span class="refentrytitle">lua_opdef</span>
        </h2>
        <p>lua_opdef — 
      Définit un opcode dans Lua durant l'initialisation. L'opcode peut prendre
      n'importe quel nombre d'arguments de sortie et/ou d'entrée, de n'importe
      quel type.
    </p>
      </div>
      <div class="refsect1">
        <a id="idm47596156684336"></a>
        <h2>
      Description
    </h2>
        <p>
      Définit un opcode en Lua durant l'initialisation. L'opcode peut prendre
      n'importe quel nombre d'arguments de sortie et/ou d'entrée, de n'importe
      quel type. Le code est exécuté durant l'initialisation, typiquement depuis
      l'en-tête de l'orchestre.  On peut déclarer et définir des variables
      globales et locales, des fonctions, des tables et des classes. Les objets
      définis dans la portée globale de Lua restent accessibles durant toute
      l'exécution, et ils sont visibles depuis tout autre code Lua situé dans
      le même fil de Csound.
    </p>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top" width="25">
                <img alt="[Note]" src="images/note.png" />
              </td>
              <th align="left">Note</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>
        Par défaut, tous les objets définis dans Lua sont dans la portée globale.
        Pour maintenir les objets confinés dans leur propre bloc de code,
        c'est-à-dire pour que les objets ne soient visibles que dans leur portée
        lexicale, il faut les déclarer avec l'attribut <span class="emphasis"><em>local</em></span>.
        Cette particularité de Lua a souvent tendance à troubler les débutants.
      </p>
                <p>
        Il faut aussi tenir compte du fait que les tableaux de Lua sont indexés
        à partir de 1 à l'inverse de ceux de C et d'autres langages de programmation
        qui sont indéxés à partir de 0.
      </p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="refsect1">
        <a id="idm47596156629840"></a>
        <h2>Syntaxe</h2>
        <pre class="synopsis"><span class="command"><strong>lua_opdef</strong></span> Sname, Sluacode</pre>
      </div>
      <div class="refsect1">
        <a id="idm47596156627920"></a>
        <h2>
      Initialisation
    </h2>
        <p>
      <span class="emphasis"><em>Sname</em></span> -- Le nom de l'opcode.
    </p>
        <p>
      <span class="emphasis"><em>Sluacode</em></span> -- Un bloc de code Lua, de n'importe quelle
      longueur. On peut entourer les blocs multi-lignes par des accolades
      doubles (<code class="literal">{{ }}</code>). Le code est évalué une seule fois
      durant l'initialisation.  
    </p>
        <p>
      Le code Lua doit définir toutes les fonctions qui seront appelées depuis
      Csound, en utilisant les conventions de nommage suivantes où
      <span class="emphasis"><em>opcodename</em></span> doit être remplacé par le nom choisi pour
      l'opcode :
    </p>
        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc; ">
            <li class="listitem">
        <code class="literal">opcodename_init</code> pour le sous-programme de l'opcode
        de taux-i.
      </li>
            <li class="listitem">
        <code class="literal">opcodename_kontrol</code> pour le sous-programme de l'opcode
        de taux-k.
      </li>
            <li class="listitem">
        <code class="literal">opcodename_audio</code> pour le sous-programme de l'opcode
        de taux-a.
      </li>
            <li class="listitem">
        <code class="literal">opcodename_noteoff</code> pour le sous-programme de fin de
        note.
      </li>
          </ul>
        </div>
        <p>
      Chacune de ces fonctions Lua recevra trois arguments légers (pointeurs) :
      l'objet CSOUND, l'instance de l'opcode et un pointeur vers les arguments
      de l'opcode, dont le code Lua doit convertir le type en celui d'une
      structure ctype de LuaJIT FFI contenant les arguments de sortie, d'entrée
      et les variables d'état de l'opcode. En utilisant, LuaJIT FFI, les éléments
      de cette structure seront accessibles comme s'ils étaient des types de Lua.
    </p>
        <p>
      Chacune de ces fonctions Lua doit retourner 0 en cas de succès et 1 en cas
      d'échec.
    </p>
        <p>
      Les fonctions Lua peuvent faire absolument tout ce que l'on veut, tout en
      sachant que si l'on désire une exécution en temps réel, il faut prendre soin
      de désactiver le ramasse-miettes de Lua et observer d'autres recommandations
      pour le code en temps réel.
    </p>
      </div>
      <div class="refsect1">
        <a id="idm47596156615056"></a>
        <h2>Exemple</h2>
        <p>
      Voici un exemple d'opcode Lua, implémentant un filtre en échelle de Moog.
      Afin de pouvoir les comparer, un opcode défini par l'utilisateur et l'opcode
      natif de Csound produisant les mêmes sonorités avec le même algorithme
      sont également montrés et chronométrés... L'exemple utilise le fichier
      <a class="ulink" href="examples/luamoog.csd" target="_top"><em class="citetitle">luamoog.csd</em></a>.
      </p>
        <div class="example">
          <a id="idm47596156611424"></a>
          <p class="title">
            <strong>Exemple 508. 
          Exemple d'opcode Lua.
        </strong>
          </p>
          <div class="example-contents">
            <div class="refsect1">
              <a id="idm47595978331376"></a>
              <pre class="programlisting">
<span class="nt">&lt;CsoundSynthesizer&gt;</span>
<span class="nt">&lt;CsInstruments&gt;</span>
<span class="vg">sr</span> <span class="o">=</span>    <span class="mi">48000</span>
<span class="vg">ksmps</span> <span class="o">=</span>   <span class="mi">100</span>
<span class="vg">nchnls</span> <span class="o">=</span>    <span class="mi">1</span>

    gi<span class="n">began</span>     <span class="nb">rtclock</span>

    <span class="nb">lua_opdef</span>   <span class="s">"moogladder"</span><span class="p">,</span> <span class="s">{{</span>
<span class="kd">local</span> <span class="n">ffi</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"</span><span class="s">ffi"</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">math</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"</span><span class="s">math"</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">string</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"</span><span class="s">string"</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">csoundApi</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'</span><span class="s">csound64.dll.5.2'</span><span class="p">)</span>
<span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="p">[[</span>
    <span class="n">int</span> <span class="n">csoundGetKsmps</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">double</span> <span class="n">csoundGetSr</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">struct</span> <span class="n">moogladder_t</span> <span class="p">{</span>
      <span class="n">double</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
      <span class="n">double</span> <span class="o">*</span><span class="n">inp</span><span class="p">;</span>
      <span class="n">double</span> <span class="o">*</span><span class="n">freq</span><span class="p">;</span>
      <span class="n">double</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
      <span class="n">double</span> <span class="o">*</span><span class="n">istor</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">sr</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">ksmps</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">thermal</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">f</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">fc</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">fc2</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">fc3</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">fcr</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">acr</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">tune</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">res4</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">input</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">j</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">k</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">kk</span><span class="p">;</span>
      <span class="n">double</span> <span class="n">stg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="n">double</span> <span class="n">delay</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="n">double</span> <span class="n">tanhstg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="p">};</span>
<span class="p">]]</span>

<span class="kd">local</span> <span class="n">moogladder_ct</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">typeof</span><span class="p">(</span><span class="s1">'</span><span class="s">struct moogladder_t *'</span><span class="p">)</span>

<span class="k">function</span> <span class="nf">moogladder_init</span><span class="p">(</span><span class="n">csound</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">carguments</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">moogladder_ct</span><span class="p">,</span> <span class="n">carguments</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sr</span> <span class="o">=</span> <span class="n">csoundApi</span><span class="p">.</span><span class="n">csoundGetSr</span><span class="p">(</span><span class="n">csound</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">ksmps</span> <span class="o">=</span> <span class="n">csoundApi</span><span class="p">.</span><span class="n">csoundGetKsmps</span><span class="p">(</span><span class="n">csound</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">istor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="k">do</span>
            <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">end</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="k">do</span>
            <span class="n">p</span><span class="p">.</span><span class="n">tanhstg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">moogladder_kontrol</span><span class="p">(</span><span class="n">csound</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">carguments</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">moogladder_ct</span><span class="p">,</span> <span class="n">carguments</span><span class="p">)</span>
    <span class="c1">-- transistor thermal voltage</span>
    <span class="n">p</span><span class="p">.</span><span class="n">thermal</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">40000.0</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">then</span>
        <span class="n">p</span><span class="p">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">end</span>
    <span class="c1">-- sr is half the actual filter sampling rate</span>
    <span class="n">p</span><span class="p">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">.</span><span class="n">sr</span>
    <span class="n">p</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">fc</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">p</span><span class="p">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">fc</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc</span>
    <span class="n">p</span><span class="p">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">fc2</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc</span>
    <span class="c1">-- frequency &amp; amplitude correction</span>
    <span class="n">p</span><span class="p">.</span><span class="n">fcr</span> <span class="o">=</span> <span class="mf">1.873</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc3</span> <span class="o">+</span> <span class="mf">0.4955</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc2</span> <span class="o">-</span> <span class="mf">0.6490</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc</span> <span class="o">+</span> <span class="mf">0.9988</span>
    <span class="n">p</span><span class="p">.</span><span class="n">acr</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.9364</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc2</span> <span class="o">+</span> <span class="mf">1.8409</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fc</span> <span class="o">+</span> <span class="mf">0.9968</span>
    <span class="c1">-- filter tuning</span>
    <span class="n">p</span><span class="p">.</span><span class="n">tune</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nb">math.exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nb">math.pi</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">fcr</span><span class="p">)))</span> <span class="o">/</span> <span class="n">p</span><span class="p">.</span><span class="n">thermal</span>
    <span class="n">p</span><span class="p">.</span><span class="n">res4</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">acr</span>
    <span class="c1">-- Nested 'for' loops crash, not sure why.</span>
    <span class="c1">-- Local loop variables also are problematic.</span>
    <span class="c1">-- Lower-level loop constructs don't crash.</span>
    <span class="n">p</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">p</span><span class="p">.</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">ksmps</span> <span class="k">do</span>
        <span class="n">p</span><span class="p">.</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">.</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">do</span>
            <span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="k">do</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">inp</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">res4</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">stg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">tune</span> <span class="o">*</span> <span class="p">(</span><span class="nb">math.tanh</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">input</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">thermal</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">tanhstg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">])</span>
                <span class="k">else</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">tanhstg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">math.tanh</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">input</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">thermal</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">then</span>
                        <span class="n">p</span><span class="p">.</span><span class="n">kk</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">tanhstg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">else</span>
                        <span class="n">p</span><span class="p">.</span><span class="n">kk</span> <span class="o">=</span> <span class="nb">math.tanh</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">thermal</span><span class="p">)</span>
                    <span class="k">end</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">stg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">tune</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">tanhstg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">kk</span><span class="p">)</span>
                <span class="k">end</span>
                <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stg</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">k</span><span class="p">]</span>
                <span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">end</span>
            <span class="c1">-- 1/2-sample delay for phase compensation</span>
            <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">stg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">p</span><span class="p">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
        <span class="n">p</span><span class="p">.</span><span class="n">out</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">delay</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">p</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">end</span>
<span class="s">}}</span>

<span class="cm">/*
Moogladder - An improved implementation of the Moog ladder filter

DESCRIPTION
This is an new digital implementation of the Moog ladder filter based on the work of Antti Huovilainen,
described in the paper \"Non-Linear Digital Implementation of the Moog Ladder Filter\" (Proceedings of DaFX04, Univ of Napoli).
This implementation is probably a more accurate digital representation of the original analogue filter.
This is version 2 (revised 14/DEC/04), with improved amplitude/resonance scaling and frequency correction using a couple of polynomials,as suggested by Antti.

SYNTAX
ar  Moogladder  asig, kcf, kres

PERFORMANCE
asig - input signal
kcf - cutoff frequency (Hz)
kres - resonance (0 - 1).

CREDITS
Victor Lazzarini
*/</span>

                    <span class="kd">opcode</span>  <span class="nf">moogladderu</span><span class="p">,</span> <span class="kt">a</span><span class="p">,</span> <span class="kt">akk</span>
a<span class="n">sig</span><span class="p">,</span> k<span class="n">cf</span><span class="p">,</span> k<span class="n">res</span>     <span class="nb">xin</span>
                    <span class="nb">setksmps</span>    <span class="mi">1</span>
i<span class="n">pi</span>                 <span class="o">=</span>           <span class="mi">4</span> <span class="o">*</span> <span class="nb">taninv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="cm">/* filter delays */</span>
a<span class="n">z1</span>                 <span class="nb">init</span>        <span class="mi">0</span>
a<span class="n">z2</span>                 <span class="nb">init</span>        <span class="mi">0</span>
a<span class="n">z3</span>                 <span class="nb">init</span>        <span class="mi">0</span>
a<span class="n">z4</span>                 <span class="nb">init</span>        <span class="mi">0</span>
a<span class="n">z5</span>                 <span class="nb">init</span>        <span class="mi">0</span>
a<span class="n">y4</span>                 <span class="nb">init</span>        <span class="mi">0</span>
a<span class="n">mf</span>                 <span class="nb">init</span>        <span class="mi">0</span>
                    <span class="k">if</span>          k<span class="n">res</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span>
k<span class="n">res</span>                <span class="o">=</span>           <span class="mi">1</span>
                    <span class="k">elseif</span>      k<span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span>
k<span class="n">res</span>                <span class="o">=</span>           <span class="mi">0</span>
                    <span class="k">endif</span>
<span class="cm">/* twice the \'thermal voltage of a transistor\' */</span>
i<span class="n">2v</span>                 <span class="o">=</span>           <span class="mi">40000</span>
<span class="cm">/* sr is half the actual filter sampling rate  */</span>
k<span class="n">fc</span>                 <span class="o">=</span>           k<span class="n">cf</span><span class="o">/</span><span class="vg">sr</span>
k<span class="n">f</span>                  <span class="o">=</span>           k<span class="n">cf</span><span class="o">/</span><span class="p">(</span><span class="vg">sr</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="cm">/* frequency &amp; amplitude correction  */</span>
k<span class="n">fcr</span>                <span class="o">=</span>           <span class="mf">1.8730</span> <span class="o">*</span> <span class="p">(</span>k<span class="n">fc</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.4955</span> <span class="o">*</span> <span class="p">(</span>k<span class="n">fc</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.6490</span> <span class="o">*</span> k<span class="n">fc</span> <span class="o">+</span> <span class="mf">0.9988</span>
k<span class="n">acr</span>                <span class="o">=</span>           <span class="o">-</span><span class="mf">3.9364</span> <span class="o">*</span> <span class="p">(</span>k<span class="n">fc</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.8409</span> <span class="o">*</span> k<span class="n">fc</span> <span class="o">+</span> <span class="mf">0.9968</span><span class="c1">;</span>
<span class="cm">/* filter tuning  */</span>
k<span class="n">2vg</span>                <span class="o">=</span>           i<span class="n">2v</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> i<span class="n">pi</span> <span class="o">*</span> k<span class="n">fcr</span> <span class="o">*</span> k<span class="n">f</span><span class="p">))</span>
<span class="cm">/* cascade of 4 1st order sections         */</span>
a<span class="n">y1</span>                 <span class="o">=</span>           a<span class="n">z1</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">((</span>a<span class="n">sig</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> k<span class="n">res</span> <span class="o">*</span> a<span class="n">mf</span> <span class="o">*</span> k<span class="n">acr</span><span class="p">)</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z1</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">))</span>
a<span class="n">z1</span>                 <span class="o">=</span>           a<span class="n">y1</span>
a<span class="n">y2</span>                 <span class="o">=</span>           a<span class="n">z2</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">(</span>a<span class="n">y1</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z2</span> <span class="o">/</span> i<span class="n">2v</span> <span class="p">))</span>
a<span class="n">z2</span>                 <span class="o">=</span>           a<span class="n">y2</span>
a<span class="n">y3</span>                 <span class="o">=</span>           a<span class="n">z3</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">(</span>a<span class="n">y2</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z3</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">))</span>
a<span class="n">z3</span>                 <span class="o">=</span>           a<span class="n">y3</span>
a<span class="n">y4</span>                 <span class="o">=</span>           a<span class="n">z4</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">(</span>a<span class="n">y3</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z4</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">))</span>
a<span class="n">z4</span>                 <span class="o">=</span>           a<span class="n">y4</span>
<span class="cm">/* 1/2-sample delay for phase compensation  */</span>
a<span class="n">mf</span>                 <span class="o">=</span>           <span class="p">(</span>a<span class="n">y4</span> <span class="o">+</span> a<span class="n">z5</span><span class="p">)</span> <span class="o">*</span><span class="mf">0.5</span>
a<span class="n">z5</span>                 <span class="o">=</span>           a<span class="n">y4</span>
<span class="cm">/* oversampling  */</span>
a<span class="n">y1</span>                 <span class="o">=</span>           a<span class="n">z1</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">((</span>a<span class="n">sig</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> k<span class="n">res</span> <span class="o">*</span> a<span class="n">mf</span> <span class="o">*</span> k<span class="n">acr</span><span class="p">)</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z1</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">))</span>
a<span class="n">z1</span>                 <span class="o">=</span>           a<span class="n">y1</span>
a<span class="n">y2</span>                 <span class="o">=</span>           a<span class="n">z2</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">(</span>a<span class="n">y1</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z2</span> <span class="o">/</span> i<span class="n">2v</span> <span class="p">))</span>
a<span class="n">z2</span>                 <span class="o">=</span>           a<span class="n">y2</span>
a<span class="n">y3</span>                 <span class="o">=</span>           a<span class="n">z3</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">(</span>a<span class="n">y2</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z3</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">))</span>
a<span class="n">z3</span>                 <span class="o">=</span>           a<span class="n">y3</span>
a<span class="n">y4</span>                 <span class="o">=</span>           a<span class="n">z4</span> <span class="o">+</span> k<span class="n">2vg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">tanh</span><span class="p">(</span>a<span class="n">y3</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">tanh</span><span class="p">(</span>a<span class="n">z4</span> <span class="o">/</span> i<span class="n">2v</span><span class="p">))</span>
a<span class="n">z4</span>                 <span class="o">=</span>           a<span class="n">y4</span>
a<span class="n">mf</span>                 <span class="o">=</span>           <span class="p">(</span>a<span class="n">y4</span> <span class="o">+</span> a<span class="n">z5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
a<span class="n">z5</span>                 <span class="o">=</span>           a<span class="n">y4</span>
                    <span class="nb">xout</span>        a<span class="n">mf</span>
                    <span class="kd">endop</span>

<span class="kd">instr</span> <span class="nf">1</span>
                <span class="nb">prints</span>      <span class="s">"No filter.</span><span class="se">\n</span><span class="s">"</span>
	k<span class="n">fe</span>         <span class="nb">expseg</span>      <span class="mi">500</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3000</span>
    k<span class="n">env</span>        <span class="nb">linen</span>       <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="nb">p3</span><span class="p">,</span> <span class="mf">0.05</span>
    a<span class="n">sig</span>        <span class="nb">buzz</span>        k<span class="n">env</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="vg">sr</span><span class="o">/</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">1</span>
    <span class="c1">; afil      moogladder  asig, kfe, 1</span>
                <span class="nb">out</span>         a<span class="n">sig</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">2</span>
                <span class="nb">prints</span>      <span class="s">"Native moogladder.</span><span class="se">\n</span><span class="s">"</span>
	k<span class="n">fe</span>         <span class="nb">expseg</span>      <span class="mi">500</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3000</span>
    k<span class="n">env</span>        <span class="nb">linen</span>       <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="nb">p3</span><span class="p">,</span> <span class="mf">0.05</span>
    a<span class="n">sig</span>        <span class="nb">buzz</span>        k<span class="n">env</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="vg">sr</span><span class="o">/</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">1</span>
    a<span class="n">fil</span>        <span class="nb">moogladder</span>  a<span class="n">sig</span><span class="p">,</span> k<span class="n">fe</span><span class="p">,</span> <span class="mi">1</span>
                <span class="nb">out</span>         a<span class="n">fil</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">3</span>
                <span class="nb">prints</span>      <span class="s">"UDO moogladder.</span><span class="se">\n</span><span class="s">"</span>
	k<span class="n">fe</span>         <span class="nb">expseg</span>      <span class="mi">500</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3000</span>
    k<span class="n">env</span>        <span class="nb">linen</span>       <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="nb">p3</span><span class="p">,</span> <span class="mf">0.05</span>
    a<span class="n">sig</span>        <span class="nb">buzz</span>        k<span class="n">env</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="vg">sr</span><span class="o">/</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">1</span>
    a<span class="n">fil</span>        <span class="nf">moogladderu</span> a<span class="n">sig</span><span class="p">,</span> k<span class="n">fe</span><span class="p">,</span> <span class="mi">1</span>
                <span class="nb">out</span>         a<span class="n">fil</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">4</span>
                <span class="nb">prints</span>      <span class="s">"Lua moogladder.</span><span class="se">\n</span><span class="s">"</span>
    k<span class="n">res</span>        <span class="nb">init</span>        <span class="mi">1</span>
    i<span class="n">stor</span>       <span class="nb">init</span>        <span class="mi">0</span>
	k<span class="n">fe</span>         <span class="nb">expseg</span>      <span class="mi">500</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="nb">p3</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3000</span>
    k<span class="n">env</span>        <span class="nb">linen</span>       <span class="mi">10000</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="nb">p3</span><span class="p">,</span> <span class="mf">0.05</span>
    a<span class="n">sig</span>        <span class="nb">buzz</span>        k<span class="n">env</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="vg">sr</span><span class="o">/</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="mi">1</span>
    a<span class="n">fil</span>        <span class="nb">init</span>        <span class="mi">0</span>
                <span class="nb">lua_ikopcall</span>    <span class="s">"moogladder"</span><span class="p">,</span> a<span class="n">fil</span><span class="p">,</span> a<span class="n">sig</span><span class="p">,</span> k<span class="n">fe</span><span class="p">,</span> k<span class="n">res</span><span class="p">,</span> i<span class="n">stor</span>
                <span class="nb">out</span>         a<span class="n">fil</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">5</span>
    gi<span class="n">ended</span>     <span class="nb">rtclock</span>
    i<span class="n">elapsed</span>    <span class="o">=</span>           gi<span class="n">ended</span> <span class="o">-</span> gi<span class="n">began</span>
                <span class="nb">print</span>       i<span class="n">elapsed</span>
    gi<span class="n">began</span>     <span class="nb">rtclock</span>
<span class="kd">endin</span>

<span class="nt">&lt;/CsInstruments&gt;</span>

<span class="nt">&lt;CsScore&gt;</span>
<span class="nb">f</span> <span class="mi">1</span>     <span class="mi">0</span> <span class="mi">65536</span> <span class="mi">10</span> <span class="mi">1</span>
<span class="nb">i</span> <span class="mf">5.1</span>   <span class="mi">0</span>   <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">4</span>     <span class="mi">1</span>   <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.2</span>   <span class="mi">21</span>  <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">4</span>     <span class="mi">22</span>  <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.3</span>   <span class="mi">42</span>  <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">2</span>     <span class="mi">43</span>  <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.4</span>   <span class="mi">63</span>  <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">2</span>     <span class="mi">64</span>  <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.5</span>   <span class="mi">84</span>  <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">3</span>     <span class="mi">85</span>  <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.6</span>   <span class="mi">105</span> <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">3</span>     <span class="mi">106</span> <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.7</span>   <span class="mi">126</span> <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">1</span>     <span class="mi">127</span> <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.8</span>   <span class="mi">147</span> <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">1</span>     <span class="mi">148</span> <span class="mi">20</span>
<span class="nb">i</span> <span class="mf">5.9</span>   <span class="mi">168</span> <span class="mi">1</span>
<span class="nb">i</span> <span class="mi">4</span>     <span class="mi">169</span> <span class="mi">20</span>
<span class="nb">i</span> <span class="mi">4</span>     <span class="mi">170</span> <span class="mi">20</span>
<span class="nb">i</span> <span class="mi">4</span>     <span class="mi">171</span> <span class="mi">20</span>
<span class="nb">e</span>
<span class="nt">&lt;/CsScore&gt;</span>

<span class="nt">&lt;/CsoundSynthesizer&gt;</span>
</pre>
            </div>
          </div>
        </div>
        <p><br class="example-break" />
    </p>
      </div>
      <div class="refsect1">
        <a id="idm47596156609648"></a>
        <h2>Voir aussi</h2>
        <p>
      <a class="link" href="lua_exec.html" title="lua_exec"><em class="citetitle">lua_exec</em></a>, 
      <a class="link" href="lua_opcall.html" title="lua_opcall"><em class="citetitle">lua_opcall</em></a>. 
    </p>
      </div>
      <div class="refsect1">
        <a id="idm47596156606608"></a>
        <h2>Crédits</h2>
        <p>
      Par : Michael Gogins, 2011
    </p>
        <p>
      Nouveau dans la version 5.13.2 de Csound.
    </p>
      </div>
    </div>
    <div class="navfooter">
      <hr />
      <table width="100%" summary="Navigation footer">
        <tr>
          <td width="40%" align="left"><a accesskey="p" href="lua_exec.html">Précédent</a> </td>
          <td width="20%" align="center">
            <a accesskey="u" href="OpcodesTop.html">Niveau supérieur</a>
          </td>
          <td width="40%" align="right"> <a accesskey="n" href="lua_opcall.html">Suivant</a></td>
        </tr>
        <tr>
          <td width="40%" align="left" valign="top">lua_exec </td>
          <td width="20%" align="center">
            <a accesskey="h" href="index.html">Sommaire</a>
          </td>
          <td width="40%" align="right" valign="top"> lua_opcall</td>
        </tr>
      </table>
    </div>
  </body>
</html>
